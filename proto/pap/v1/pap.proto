syntax = "proto3";

package pap.v1;

option go_package = "github.com/pluggedin/pap/proto/pap/v1;papv1";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

// PAP defines a uniform envelope around commands, responses, telemetry,
// and lifecycle directives exchanged between the Station and Satellites.
// This schema supports both PAP-CP (Control Plane) and PAP-Hooks (Open I/O) profiles.

// PAPMessage is the top-level message structure for PAP-CP (Control Plane) profile
message PAPMessage {
  Header header = 1;
  oneof payload {
    ProvisionRequest provision = 2;
    ProvisionResponse provision_response = 3;
    InvokeRequest invoke = 4;
    InvokeResponse invoke_response = 5;
    HeartbeatEvent heartbeat = 6;
    MetricsReport metrics = 7;
    TerminateRequest terminate = 8;
    TerminateResponse terminate_response = 9;
    TransferInit transfer_init = 10;
    TransferAccept transfer_accept = 11;
    TransferComplete transfer_complete = 12;
    Error error = 13;
  }
  bytes signature = 15;  // Ed25519 signature (REQUIRED for PAP-CP)
  bytes checksum = 16;   // SHA-256 checksum (REQUIRED for PAP-CP)
}

// Header contains routing, correlation, and security metadata
message Header {
  string version = 1;      // Protocol version, e.g. "pap-cp/1.0"
  string agent_uuid = 2;   // Persistent agent identifier: "namespace/agent@v1.0"
  string station_id = 3;   // Station identifier, e.g. "plugged.in"
  string instance_id = 4;  // Per-process UUID
  int64 timestamp = 5;     // Unix microseconds
  bytes nonce = 6;         // 32-byte random for replay protection (REQUIRED)
  string trace_id = 7;     // OpenTelemetry trace ID (16-byte hex)
  string span_id = 8;      // OpenTelemetry span ID (8-byte hex)
  string correlation_id = 9; // Optional correlation ID for request grouping
}

// MessageEnvelope (Legacy - maintained for backward compatibility)
message MessageEnvelope {
  string message_id = 1;
  string parent_id = 2;
  string correlation_id = 3;
  google.protobuf.Timestamp sent_at = 4;
  AgentIdentity sender = 5;
  AuthContext auth = 6;
  map<string, string> annotations = 7;
  MessageBody body = 8;
  // OpenTelemetry-compatible identifiers for end-to-end tracing
  string trace_id = 9; // 16-byte hex string
  string span_id = 10; // 8-byte hex string
}

message AgentIdentity {
  string agent = 1;    // e.g. "focus-sat-01"
  string cluster = 2;  // e.g. "orbital-a"
  string version = 3;  // protocol implementation version
  string instance = 4; // unique process identifier within the agent
}

message AuthContext {
  bytes signature = 1;      // Signature over canonicalized envelope
  string algorithm = 2;     // e.g. "ed25519"
  bytes payload_hash = 3;   // SHA-256 hash of MessageBody
  string nonce = 4;         // Replay protection token
  google.protobuf.Timestamp issued_at = 5;
}

message MessageBody {
  oneof payload {
    Invoke invoke = 1;
    Response response = 2;
    Event event = 3;
    Error error = 4;
    ControlDirective control = 5;
    HandshakeAck handshake_ack = 6;
  }
}

message Invoke {
  Target target = 1;
  string method = 2;
  google.protobuf.Struct arguments = 3;
  google.protobuf.Timestamp deadline = 4;
  bool expect_reply = 5;
  map<string, string> metadata = 6;
}

message Target {
  string agent = 1;      // Destination agent DNS label
  string namespace = 2;  // Logical namespace or capability scope
  string capability = 3; // Requested capability identifier
}

message Response {
  ErrorCode status = 1;
  repeated Output outputs = 2;
  map<string, string> metadata = 3;
  bool is_final = 4;
}

message Output {
  string content_type = 1;
  bytes data = 2;
  google.protobuf.Struct annotations = 3;
}

message Event {
  EventType type = 1;
  google.protobuf.Struct context = 2;
  oneof detail {
    Heartbeat heartbeat = 10;
    Log log = 11;
    Alert alert = 12;
    MetricBatch metrics = 13;
  }
}

enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_HEARTBEAT = 1;
  EVENT_TYPE_LOG = 2;
  EVENT_TYPE_ALERT = 3;
  EVENT_TYPE_METRIC = 4;
}

// HeartbeatEvent - LIVENESS ONLY (Zombie Prevention)
// CRITICAL: Heartbeats MUST carry only liveness information.
// Resource telemetry (CPU, memory) MUST be sent via MetricsReport.
message HeartbeatEvent {
  Header header = 1;
  HeartbeatMode mode = 2;      // Agent operational mode
  uint64 uptime_seconds = 3;    // Process uptime in seconds
  // NO OTHER FIELDS ALLOWED - This is the zombie-prevention superpower!
}

enum HeartbeatMode {
  HEARTBEAT_MODE_UNSPECIFIED = 0;
  EMERGENCY = 1;  // Critical state, heartbeat every 5s
  IDLE = 2;       // Normal operation, heartbeat every 30s
  SLEEP = 3;      // Low activity, heartbeat every 15min
}

// MetricsReport - Resource Telemetry (Separate from Liveness)
// All resource metrics MUST be sent here, NOT in HeartbeatEvent
message MetricsReport {
  Header header = 1;
  float cpu_percent = 2;        // CPU utilization percentage
  uint64 memory_mb = 3;         // Memory usage in megabytes
  uint64 requests_handled = 4;  // Number of requests processed
  map<string, double> custom_metrics = 5; // Agent-specific metrics
}

message Log {
  string level = 1; // e.g. "INFO", "WARN"
  string message = 2;
  map<string, google.protobuf.Value> fields = 3;
}

message Alert {
  string title = 1;
  string description = 2;
  Severity severity = 3;
  map<string, google.protobuf.Value> labels = 4;
}

message MetricBatch {
  repeated MetricPoint points = 1;
}

message MetricPoint {
  string name = 1;
  double value = 2;
  google.protobuf.Timestamp observed_at = 3;
  map<string, string> attributes = 4;
}

enum Severity {
  SEVERITY_UNSPECIFIED = 0;
  SEVERITY_INFO = 1;
  SEVERITY_WARNING = 2;
  SEVERITY_CRITICAL = 3;
}

message Error {
  ErrorCode code = 1;
  string message = 2;
  bool recoverable = 3;
  map<string, google.protobuf.Value> details = 4;
}

message ControlDirective {
  ControlType type = 1;
  google.protobuf.Struct arguments = 2;
  google.protobuf.Timestamp enforce_at = 3;
}

enum ControlType {
  CONTROL_TYPE_UNSPECIFIED = 0;
  CONTROL_TYPE_TERMINATE = 1;
  CONTROL_TYPE_FORCE_KILL = 2;
  CONTROL_TYPE_PAUSE = 3;
  CONTROL_TYPE_RESUME = 4;
  CONTROL_TYPE_PING = 5;
}

enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  OK = 1;
  ACCEPTED = 2;
  BAD_REQUEST = 3;
  UNAUTHORIZED = 4;
  FORBIDDEN = 5;
  NOT_FOUND = 6;
  TIMEOUT = 7;
  CONFLICT = 8;
  RATE_LIMITED = 9;
  AGENT_UNHEALTHY = 10;
  AGENT_BUSY = 11;
  DEPENDENCY_FAILED = 12;
  INTERNAL_ERROR = 13;
  PROXY_ERROR = 14;
  VERSION_UNSUPPORTED = 15;
}

message HandshakeRequest {
  string protocol_version = 1;
  string agent_name = 2;
  string cluster = 3;
  repeated Capability capabilities = 4;
  bytes signing_public_key = 5;
  string token = 6;
}

message Capability {
  string name = 1;                // Capability identifier
  map<string, string> config = 2; // Capability-specific configuration
}

message HandshakeResponse {
  string protocol_version = 1;
  AgentIdentity identity = 2;
  repeated Capability capabilities = 3;
  CertificateBundle certificate = 4;
  google.protobuf.Timestamp issued_at = 5;
  google.protobuf.Timestamp expires_at = 6;
  bytes station_signature = 7; // Signature over the response
}

message CertificateBundle {
  string certificate_pem = 1;
  string ca_certificate_pem = 2;
}

message HandshakeAck {
  bool accepted = 1;
  string reason = 2;
}

// ============================================================================
// PAP v1.0 Lifecycle Messages (Paper-Aligned)
// ============================================================================

// Lifecycle States
enum LifecycleState {
  LIFECYCLE_STATE_UNSPECIFIED = 0;
  NEW = 1;           // Agent created but not provisioned
  PROVISIONED = 2;   // Credentials issued, not yet active
  ACTIVE = 3;        // Operational and handling requests
  DRAINING = 4;      // Graceful shutdown in progress
  TERMINATED = 5;    // Clean shutdown completed
  KILLED = 6;        // Force-killed by Station
}

// Provisioning Flow Messages
message ProvisionRequest {
  string agent_uuid = 1;           // e.g. "namespace/research@v1.2"
  Credentials credentials = 2;     // TLS cert and signing keys
  AgentConfiguration configuration = 3; // MCP servers, models, policies
}

message Credentials {
  string tls_cert = 1;             // PEM-encoded X.509 certificate
  string signing_key_ref = 2;      // Reference to Ed25519 key (e.g. vault path)
}

message AgentConfiguration {
  repeated string mcp_servers = 1;  // e.g. ["filesystem@v2.1", "web-search@v1.5"]
  repeated string models = 2;       // e.g. ["gpt-4", "claude-3"]
  MemoryConfiguration memory = 3;
  map<string, string> policies = 4; // e.g. {"max_tokens": "100000", "timeout": "300"}
}

message MemoryConfiguration {
  string type = 1;        // e.g. "vector", "graph"
  string provider = 2;    // e.g. "pinecone", "weaviate"
  map<string, string> config = 3;
}

message ProvisionResponse {
  ErrorCode status = 1;
  string instance_id = 2;          // Unique instance identifier
  repeated string capabilities = 3; // e.g. ["a2a-0.3", "mcp-2025-06-18"]
  string message = 4;
}

// Invoke Messages (Control Operations)
message InvokeRequest {
  Target target = 1;
  string method = 2;
  google.protobuf.Struct arguments = 3;
  google.protobuf.Timestamp deadline = 4;
  bool expect_reply = 5;
  map<string, string> metadata = 6;
}

message InvokeResponse {
  ErrorCode status = 1;
  repeated Output outputs = 2;
  map<string, string> metadata = 3;
  bool is_final = 4;
}

// Termination Messages
message TerminateRequest {
  string agent_uuid = 1;
  uint32 grace_period_seconds = 2; // Time allowed for graceful shutdown
  string reason = 3;
}

message TerminateResponse {
  ErrorCode status = 1;
  string message = 2;
  uint32 tasks_drained = 3;        // Number of tasks completed during drain
}

// Ownership Transfer Messages
message TransferInit {
  string agent_uuid = 1;            // e.g. "namespace/agent@v1.2"
  string target_station = 2;        // e.g. "station-b.example.com"
  bool preserve_state = 3;          // Whether to transfer agent state
  google.protobuf.Timestamp initiated_at = 4;
}

message TransferAccept {
  string agent_uuid = 1;
  Credentials new_credentials = 2;  // New credentials from target station
  string transfer_token = 3;        // Token authorizing the transfer
}

message TransferComplete {
  string agent_uuid = 1;
  string old_station = 2;           // e.g. "plugged.in"
  string new_station = 3;           // e.g. "station-b.example.com"
  bool keys_rotated = 4;            // Confirmation of credential rotation
  google.protobuf.Timestamp completed_at = 5;
}
